# Trading CRM API Payload Verification

## ‚úÖ Current Payload Format (Matches Broker Requirements)

Our implementation sends **exactly** the format requested by the broker:

```json
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john.doe@example.com",
  "phone": "+60123456789",
  "affiliateTransactionId": "LEAD_1699234567_abc123",
  "isoCountry": "MY",
  "subAffiliate": "",
  "campaignId": "",
  "tag": "signal_pulse",
  "tag1": "",
  "registrationUrl": "https://yourdomain.com",
  "additionalInfo1": "",
  "additionalInfo2": "",
  "additionalInfo3": "",
  "language": "ms",
  "ip": "123.45.67.89",
  "isVerified": false,
  "promotionCode": "defaultAcademiesGroup",
  "password": "",
  "utmCampaign": "",
  "utmSource": "pksignalpulse"
}
```

## üìã Field Mapping

| Field | Value | Source |
|-------|-------|--------|
| `firstName` | User's first name | Form input |
| `lastName` | User's last name | Form input |
| `email` | User's email | Form input |
| `phone` | Full phone with country code | Form input |
| `affiliateTransactionId` | Unique ID per lead | Auto-generated: `LEAD_{timestamp}_{random}` |
| `isoCountry` | ISO country code (MY, TR, FR, etc.) | Form input (uppercase) |
| `subAffiliate` | Sub-affiliate ID | Empty string (optional) |
| `campaignId` | Campaign/Source number | From env or empty |
| `tag` | Funnel name | Default: "signal_pulse" |
| `tag1` | Additional tag | From request or empty |
| `registrationUrl` | Signup page URL | App URL |
| `additionalInfo1` | Custom field 1 | From request or empty |
| `additionalInfo2` | Custom field 2 | From request or empty |
| `additionalInfo3` | Custom field 3 | From request or empty |
| `language` | User's language | Auto-detected from country |
| `ip` | User's IP address | From request headers |
| `isVerified` | Email verified? | Always `false` |
| `promotionCode` | Promotion/Group code | From env: `defaultAcademiesGroup` |
| `password` | User password | Empty (auto-generated by CRM) |
| `utmCampaign` | UTM campaign | From request or empty |
| `utmSource` | UTM source | Default: "pksignalpulse" |

## üéØ Key Points (Confirmed by Broker)

‚úÖ **No currency field** - Not included in payload
‚úÖ **Main parameters**: `language` and `isoCountry`
‚úÖ **Exact format** - Matches broker's CURL example

## üåç Language Auto-Detection

Based on country code:

| Country | Language Code |
|---------|--------------|
| MY (Malaysia) | ms |
| TR (Turkey) | tr |
| FR (France) | fr |
| IT (Italy) | it |
| HK (Hong Kong) | zh |
| SG (Singapore) | en |
| TW (Taiwan) | zh |
| BR (Brazil) | pt |

## üì° API Details

- **Endpoint**: `https://affiliate365.tradingcrm.com:4477/accounts/registrationwithsso`
- **Method**: POST
- **Content-Type**: `application/json-patch+json`
- **Authorization**: Bearer token (obtained via Basic Auth)
- **Username**: `225X`

## üîç Debugging

When a lead is sent, check the **server logs** to see:

1. **Exact payload sent**:
   ```
   üì§ Exact Payload (JSON): { ... }
   ```

2. **API response**:
   ```
   üì• Trading CRM Response: { status: 200, data: { ... } }
   ```

3. **Any errors**:
   ```
   ‚ùå Trading CRM API Error: { status: 400, error: "..." }
   ```

## ‚úÖ Verification Checklist

- [x] Payload matches broker's exact format
- [x] No currency field included
- [x] Language is properly set based on country
- [x] isoCountry is uppercase
- [x] All required fields are present
- [x] Empty strings for optional fields
- [x] Bearer token authentication working
- [x] Detailed logging enabled

## üß™ Test Payload Example (Malaysia)

```json
{
  "firstName": "Test",
  "lastName": "User",
  "email": "test@example.com",
  "phone": "+60123456789",
  "affiliateTransactionId": "LEAD_1699234567_abc123",
  "isoCountry": "MY",
  "subAffiliate": "",
  "campaignId": "",
  "tag": "signal_pulse",
  "tag1": "",
  "registrationUrl": "https://tradeflow.blog",
  "additionalInfo1": "",
  "additionalInfo2": "",
  "additionalInfo3": "",
  "language": "ms",
  "ip": "123.45.67.89",
  "isVerified": false,
  "promotionCode": "defaultAcademiesGroup",
  "password": "",
  "utmCampaign": "",
  "utmSource": "pksignalpulse"
}
```

## üìû If Issues Persist

Check server logs for:
1. The exact JSON payload being sent
2. The HTTP status code received
3. The full error message from Trading CRM API

All logs now include `üì§` for requests and `üì•` for responses.
